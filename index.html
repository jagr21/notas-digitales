<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas Digitales</title>
    <!-- Fuentes Modernas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Variables de Dise√±o */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
            --text-color: #34495e;
            --success-color: #27ae60;
            --shadow: 0 10px 20px rgba(0,0,0,0.1);
            --radius: 15px;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        main {
            width: 90%;
            max-width: 1000px;
            margin: 20px;
        }

        h1, h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* Gesti√≥n de Pantallas */
        .screen {
            display: none;
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            animation: fadeIn 0.4s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pantalla de Inicio - Banderas */
        .flags-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .flag-btn {
            border: none;
            background: none;
            cursor: pointer;
            transition: transform 0.3s ease, filter 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .flag-btn:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
        }

        .flag-btn img {
            width: 200px;
            height: 133px; /* Aspect ratio */
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .flag-btn span {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Pantalla de Men√∫ - Grados */
        .grades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .grade-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .grade-btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }

        /* Pantalla de Clase - Tabla */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            background-color: white;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Botones de Acci√≥n */
        .btn-action {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            color: white;
        }
        .btn-add { background-color: var(--success-color); font-size: 0.9rem; }
        .btn-add:hover { background-color: #219150; }
        .btn-delete { background-color: #e74c3c; padding: 5px 10px; font-size: 0.9rem; border-radius: 5px; color: white; border: none; cursor: pointer; }
        .btn-delete:hover { background-color: #c0392b; }

        /* Utilidades */
        .back-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background-color: #eee;
        }

        .loader {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--accent-color);
        }

        .hidden {
            display: none;
        }

        /* Barra de B√∫squeda */
        .search-container {
            margin-bottom: 20px;
        }
        #search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        #search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Optimizaci√≥n M√≥vil (Vista de Tarjetas) */
        @media (max-width: 768px) {
            .screen { padding: 20px; }
            thead { display: none; } /* Ocultar encabezados de tabla */
            
            tr {
                display: block;
                margin-bottom: 20px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                border: 1px solid #eee;
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                border-bottom: 1px solid #eee;
                text-align: right;
            }
            
            td:last-child { border-bottom: none; }
            
            td::before { content: attr(data-label); font-weight: bold; color: var(--primary-color); text-align: left; }
            
            /* Estilos para el acorde√≥n m√≥vil */
            td:first-child { 
                background-color: var(--primary-color); 
                color: white; 
                justify-content: flex-start; /* Alineaci√≥n a la izquierda */
                text-align: left;
                border-radius: 10px 10px 0 0; 
                cursor: pointer;
                padding-left: 20px;
                padding-right: 20px;
            }
            td:first-child::before { display: none; }

            /* Ocultar contenido por defecto en m√≥vil */
            td:not(:first-child) { display: none; }
            tr.expanded td:not(:first-child) { display: flex; animation: fadeIn 0.3s; }
        }

        /* Estilos del Popup (Modal) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .close-modal:hover { color: #000; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: var(--primary-color); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: inherit;
        }
        .info-icon {
            cursor: pointer; margin-left: 8px; color: white; opacity: 0.7; transition: opacity 0.2s;
            display: inline-block; vertical-align: middle;
        }
        .info-icon:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>

    <main>
        <!-- 1. Pantalla de Inicio -->
        <section id="screen-home" class="screen active">
            <h1>Notas Digitales</h1>
            <div class="flags-container">
                <button class="flag-btn" onclick="selectLanguage('Italiano')">
                    <img src="https://flagcdn.com/w320/it.png" alt="Italia">
                    <span>Italiano</span>
                </button>
                <button class="flag-btn" onclick="selectLanguage('Ingles')">
                    <img src="https://flagcdn.com/w320/gb.png" alt="Reino Unido">
                    <span>Ingl√©s</span>
                </button>
            </div>
        </section>

        <!-- 2. Pantalla de Selecci√≥n de Grado -->
        <section id="screen-menu" class="screen">
            <button class="back-btn" onclick="goHome()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Volver al inicio
            </button>
            <h2 id="menu-title">Selecciona el Grado</h2>
            <div class="grades-grid">
                <button class="grade-btn" onclick="selectGrade('1A')">1er Grado A</button>
                <button class="grade-btn" onclick="selectGrade('1B')">1er Grado B</button>
                <button class="grade-btn" onclick="selectGrade('2')">2do Grado</button>
                <button class="grade-btn" onclick="selectGrade('3')">3er Grado</button>
                <button class="grade-btn" onclick="selectGrade('4')">4to Grado</button>
                <button class="grade-btn" onclick="selectGrade('5')">5to Grado</button>
                <button class="grade-btn" onclick="selectGrade('6')">6to Grado</button>
            </div>
        </section>

        <!-- 3. Pantalla de Lista de Alumnos -->
        <section id="screen-class" class="screen">
            <button class="back-btn" onclick="goBackToMenu()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Volver a grados
            </button>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 id="class-title" style="margin-bottom: 0;">Lista de Alumnos</h2>
                <button class="btn-action btn-add" onclick="addStudent()">+ Nuevo Alumno</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar alumno por nombre..." onkeyup="filterStudents()">
            </div>
            
            <div id="loader" class="loader hidden">Cargando datos...</div>
            
            <div class="table-wrapper">
                <table id="students-table">
                    <thead>
                        <tr>
                            <th>Alumno</th>
                            <th>
                                Nota I 
                                <svg class="info-icon" onclick="openInfoModal(1)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </th>
                            <th>
                                Nota II
                                <svg class="info-icon" onclick="openInfoModal(2)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </th>
                            <th>
                                Nota III
                                <svg class="info-icon" onclick="openInfoModal(3)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="students-body">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Popup de Informaci√≥n de Evaluaci√≥n -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeInfoModal()">&times;</span>
            <h2 id="modal-title">Informaci√≥n Evaluaci√≥n</h2>
            
            <div class="form-group">
                <label>Tipo de Evaluaci√≥n</label>
                <select id="eval-type">
                    <option value="Interrogatorio">Interrogatorio</option>
                    <option value="Examen escrito">Examen escrito</option>
                    <option value="Taller">Taller</option>
                    <option value="Exposici√≥n">Exposici√≥n</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tema</label>
                <input type="text" id="eval-topic" placeholder="Ej. Verbos irregulares">
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="eval-date">
            </div>
            <div class="form-group">
                <label>Notas Adicionales</label>
                <textarea id="eval-notes" rows="3" placeholder="Detalles extra..."></textarea>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn-action btn-delete" onclick="deleteEvalInfo()">Borrar Info</button>
                <button class="btn-action btn-add" onclick="saveEvalInfo()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        // URL del Script de Google Apps (Corregida y verificada del contexto anterior)
        const API_URL = "https://script.google.com/macros/s/AKfycbxgy3A4lQ6EPg-0FSmVDIkw-8P_-3AjDtW5KutjmbOsgxh2tiomZoZe0jcpu6FTlYcs/exec"; // <--- ¬°ASEG√öRATE DE QUE ESTA SEA TU URL REAL!

        // ESTADO
        let currentLang = '';
        let currentGrade = '';
        let currentMeta = {}; // Almacena la info de las evaluaciones
        let currentEvalIndex = null; // Para saber qu√© evaluaci√≥n se est√° editando

        // ELEMENTOS DOM
        const screenHome = document.getElementById('screen-home');
        const screenMenu = document.getElementById('screen-menu');
        const screenClass = document.getElementById('screen-class');
        const menuTitle = document.getElementById('menu-title');
        const classTitle = document.getElementById('class-title');
        const studentsBody = document.getElementById('students-body');
        const loader = document.getElementById('loader');
        const infoModal = document.getElementById('info-modal');

        // NAVEGACI√ìN
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        function selectLanguage(lang) {
            currentLang = lang;
            menuTitle.textContent = `Grados de ${lang}`;
            showScreen(screenMenu);
        }

        function goHome() {
            currentLang = '';
            showScreen(screenHome);
        }

        function selectGrade(grade) {
            currentGrade = grade;
            classTitle.textContent = `${currentLang} - Grado ${grade}`;
            showScreen(screenClass);
            fetchStudents();
        }

        function goBackToMenu() {
            currentGrade = '';
            studentsBody.innerHTML = ''; // Limpiar tabla
            showScreen(screenMenu);
        }

        // L√ìGICA DE DATOS
        async function fetchStudents() {
            loader.classList.remove('hidden');
            studentsBody.innerHTML = '';
            
            // Limpiar b√∫squeda al recargar datos
            if(document.getElementById('search-input')) document.getElementById('search-input').value = '';

            try {
                // Construir URL con par√°metros
                const url = `${API_URL}?lang=${currentLang}&grade=${currentGrade}&t=${new Date().getTime()}`;
                
                const response = await fetch(url);
                const responseData = await response.json();

                if (responseData.error) {
                    alert('Error: ' + responseData.error);
                    return;
                }

                // Separar alumnos y metadatos
                const students = responseData.students || [];
                currentMeta = responseData.meta || {};
                
                renderTable(students);

            } catch (error) {
                console.error(error);
                studentsBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">Error al cargar datos. Verifica tu conexi√≥n.</td></tr>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderTable(students) {
            if (!students || students.length === 0) {
                studentsBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">No hay alumnos registrados.</td></tr>`;
                return;
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                
                // Asumimos que las columnas en el Sheet son: studentId, Nombres, Apellidos, Nota I, Fecha I
                // Si no existen, usamos fallbacks vac√≠os
                const nombreCompleto = `${student.Nombres || ''} ${student.Apellidos || ''}`.trim() || student['Nombre Completo'] || 'Sin Nombre';

                row.innerHTML = `
                    <td data-label="Alumno" onclick="toggleMobileRow(this)">${nombreCompleto}</td>
                    ${renderGradeCell(student, 'Nota I', 'Fecha I', 1)}
                    ${renderGradeCell(student, 'Nota II', 'Fecha II', 2)}
                    ${renderGradeCell(student, 'Nota III', 'Fecha III', 3)}
                    <td data-label="Acci√≥n" style="text-align: center;"><button class="btn-delete" onclick="deleteStudent('${student.studentId}')" title="Borrar Alumno">üóëÔ∏è</button></td>
                `;
                studentsBody.appendChild(row);
            });
        }

        // Funci√≥n auxiliar para crear la celda de nota + fecha
        function renderGradeCell(student, noteKey, dateKey, evalIndex) {
            const notaActual = student[noteKey] || '';
            const fechaActual = student[dateKey] || '';
            const dateStr = fechaActual ? new Date(fechaActual).toLocaleDateString() : '-';

            return `
                <td data-label="${noteKey}">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <select onchange="updateGrade('${student.studentId}', this, ${evalIndex})">
                            <option value="" ${notaActual === '' ? 'selected' : ''}>-</option>
                            <option value="A+" ${notaActual === 'A+' ? 'selected' : ''}>A+</option>
                            <option value="A" ${notaActual === 'A' ? 'selected' : ''}>A</option>
                            <option value="B" ${notaActual === 'B' ? 'selected' : ''}>B</option>
                            <option value="C" ${notaActual === 'C' ? 'selected' : ''}>C</option>
                            <option value="D" ${notaActual === 'D' ? 'selected' : ''}>D</option>
                            <option value="E" ${notaActual === 'E' ? 'selected' : ''}>E</option>
                            <option value="F" ${notaActual === 'F' ? 'selected' : ''}>F</option>
                        </select>
                        <span class="date-label" style="font-size:0.75rem; color:#7f8c8d;">${dateStr}</span>
                    </div>
                </td>
            `;
        }

        // --- FUNCI√ìN CENTRAL DE ENV√çO (M√âTODO ROBUSTO) ---
        async function sendDataToScript(payload) {
            console.log("Enviando a Google Sheet:", payload);
            
            // Usamos URLSearchParams para enviar como formulario.
            // Este es el m√©todo que S√ç lograba comunicarse con el script.
            const params = new URLSearchParams();
            params.append('payload', JSON.stringify(payload));

            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: params
            });
        }

        async function updateGrade(studentId, selectElement, evalIndex) {
            const newGrade = selectElement.value;
            const cell = selectElement.closest('div');
            const dateLabel = cell.querySelector('.date-label');
            
            // Feedback visual inmediato (Deshabilitar)
            selectElement.disabled = true;
            document.body.style.cursor = 'wait';

            const payload = {
                lang: currentLang,
                grade: currentGrade,
                studentId: studentId,
                newGrade: newGrade,
                evalIndex: evalIndex,
                action: 'updateGrade'
            };

            try {
                await sendDataToScript(payload);

                // Como es no-cors, asumimos √©xito si no lanza error de red
                // Actualizamos la fecha localmente
                const today = new Date().toLocaleDateString();
                dateLabel.textContent = newGrade ? today : '-';
                
                // Efecto visual de √©xito (borde verde temporal)
                selectElement.style.borderColor = 'var(--success-color)';
                setTimeout(() => selectElement.style.borderColor = '#ddd', 2000);

            } catch (error) {
                console.error('Error saving grade:', error);
                alert('No se pudo guardar la nota. Intenta de nuevo.');
                // Revertir cambio visualmente si es posible, o recargar
            } finally {
                selectElement.disabled = false;
                document.body.style.cursor = 'default';
            }
        }

        async function addStudent() {
            const nombres = prompt("Ingrese los Nombres del alumno:");
            if (!nombres) return;
            const apellidos = prompt("Ingrese los Apellidos del alumno:");
            if (!apellidos) return;

            loader.classList.remove('hidden');
            
            const payload = {
                action: 'addStudent',
                lang: currentLang,
                grade: currentGrade,
                nombres: nombres,
                apellidos: apellidos
            };

            try {
                await sendDataToScript(payload);
                // Recargar la tabla para ver el nuevo alumno (con un peque√±o delay para asegurar que GS proces√≥)
                setTimeout(fetchStudents, 1500);
            } catch (error) {
                console.error(error);
                alert("Error al agregar alumno.");
                loader.classList.add('hidden');
            }
        }

        async function deleteStudent(studentId) {
            if (!confirm("¬øEst√°s seguro de que quieres eliminar a este alumno y todas sus notas? Esta acci√≥n no se puede deshacer.")) return;

            loader.classList.remove('hidden');
            const payload = { action: 'deleteStudent', lang: currentLang, grade: currentGrade, studentId: studentId };

            try {
                await sendDataToScript(payload);
                setTimeout(fetchStudents, 1500);
            } catch (error) {
                console.error(error);
                alert("Error al eliminar alumno.");
                loader.classList.add('hidden');
            }
        }

        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
        }

        function filterStudents() {
            const input = document.getElementById('search-input');
            const filterTerms = normalizeText(input.value).split(" ").filter(term => term.trim() !== "");
            const rows = studentsBody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const td = rows[i].getElementsByTagName('td')[0]; // Primera celda (Nombre)
                if (td) {
                    const txtValue = normalizeText(td.textContent || td.innerText);
                    const isMatch = filterTerms.every(term => txtValue.indexOf(term) > -1);
                    rows[i].style.display = isMatch ? "" : "none";
                }
            }
        }

        function toggleMobileRow(cell) {
            // Solo activa si estamos en vista m√≥vil
            if (window.innerWidth <= 768) {
                cell.parentElement.classList.toggle('expanded');
            }
        }

        // --- L√ìGICA DEL POPUP DE INFORMACI√ìN ---
        function openInfoModal(evalIndex) {
            currentEvalIndex = evalIndex;
            document.getElementById('modal-title').textContent = `Informaci√≥n Evaluaci√≥n #${evalIndex}`;
            
            // Cargar datos si existen
            const infoStr = currentMeta[evalIndex];
            let info = {};
            try {
                // Verificamos si parece JSON antes de parsear para evitar errores con encabezados de texto
                if (infoStr && typeof infoStr === 'string' && infoStr.trim().startsWith('{')) {
                    info = JSON.parse(infoStr);
                }
            } catch (e) { console.warn("No se pudo leer la info (se reiniciar√°):", e); }

            document.getElementById('eval-type').value = info.type || 'Interrogatorio';
            document.getElementById('eval-topic').value = info.topic || '';
            document.getElementById('eval-date').value = info.date || '';
            document.getElementById('eval-notes').value = info.notes || '';

            infoModal.style.display = 'flex';
        }

        function closeInfoModal() {
            infoModal.style.display = 'none';
            currentEvalIndex = null;
        }

        async function saveEvalInfo() {
            if (!currentEvalIndex) return;

            const info = {
                type: document.getElementById('eval-type').value,
                topic: document.getElementById('eval-topic').value,
                date: document.getElementById('eval-date').value,
                notes: document.getElementById('eval-notes').value
            };

            // Actualizar localmente
            currentMeta[currentEvalIndex] = JSON.stringify(info);

            const payload = {
                action: 'updateEvalInfo',
                lang: currentLang,
                grade: currentGrade,
                evalIndex: parseInt(currentEvalIndex, 10), // Forzar env√≠o como n√∫mero
                info: info
            };

            closeInfoModal();
            loader.classList.remove('hidden');

            try {
                await sendDataToScript(payload);
                // No recargamos toda la tabla, solo ocultamos el loader
            } catch (error) {
                alert("Error al guardar informaci√≥n.");
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function deleteEvalInfo() {
            if (!confirm("¬øBorrar toda la informaci√≥n de esta evaluaci√≥n?")) return;
            document.getElementById('eval-topic').value = '';
            document.getElementById('eval-date').value = '';
            document.getElementById('eval-notes').value = '';
            saveEvalInfo(); // Guardar vac√≠o
        }
    </script>
</body>
</html>
