<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas Digitales</title>
    <!-- Fuentes Modernas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Variables de Dise√±o */
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
            --text-color: #34495e;
            --success-color: #27ae60;
            --shadow: 0 10px 20px rgba(0,0,0,0.1);
            --radius: 15px;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        main {
            width: 90%;
            max-width: 1000px;
            margin: 20px;
        }

        h1, h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* Gesti√≥n de Pantallas */
        .screen {
            display: none;
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            animation: fadeIn 0.4s ease-out;
            position: relative;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pantalla de Inicio - Banderas */
        .flags-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .flag-btn {
            border: none;
            background: none;
            cursor: pointer;
            transition: transform 0.3s ease, filter 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .flag-btn:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
        }

        .flag-btn img {
            width: 200px;
            height: 133px; /* Aspect ratio */
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .flag-btn span {
            margin-top: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Pantalla de Men√∫ - Grados */
        .grades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .grade-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 90px; /* Altura fija para uniformidad */
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grade-btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
        }

        /* Estilo verde para Italiano */
        .grade-btn.italian {
            background-color: var(--success-color);
        }
        .grade-btn.italian:hover {
            background-color: #219150;
        }

        /* Pantalla de Clase - Tabla */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            background-color: white;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Botones de Acci√≥n */
        .btn-action {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            color: white;
        }
        .btn-add { background-color: var(--success-color); font-size: 0.9rem; }
        .btn-add:hover { background-color: #219150; }

        .btn-refresh {
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: var(--primary-color);
            padding: 6px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            box-shadow: none;
        }
        .btn-refresh:hover { background-color: rgba(0,0,0,0.05); transform: rotate(180deg); color: var(--accent-color); }
        
        /* Men√∫ de Acciones (Tres puntos) */
        .action-menu-container {
            position: relative;
            display: inline-block;
        }
        .btn-menu {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 10px;
            color: var(--text-color);
            line-height: 1;
        }
        .btn-menu:hover {
            color: var(--accent-color);
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #fff;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 5px;
            overflow: hidden;
            text-align: left;
        }
        .dropdown-content button {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
        }
        .dropdown-content button:hover {
            background-color: #f1f1f1;
        }
        .dropdown-content button.delete-option {
            color: #e74c3c;
        }
        .show { display: block; }

        /* Utilidades */
        .back-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background-color: #eee;
        }

        .loader {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--accent-color);
        }

        .hidden {
            display: none;
        }

        /* Barra de B√∫squeda */
        .search-container {
            margin-bottom: 20px;
        }
        #search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        #search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Optimizaci√≥n M√≥vil (Vista de Tarjetas) */
        @media (max-width: 1024px) {
            .screen { padding: 20px; }
            .mobile-eval-info-container {
                display: flex !important;
            }
            .toggle-rows-btn {
                display: flex !important;
            }
            
            .filter-toolbar {
                flex-wrap: nowrap;
            }
            .filter-toolbar select {
                min-width: 0;
            }

            #toast-container {
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                align-items: center;
            }

            /* Mover bot√≥n de actualizar arriba a la derecha en m√≥vil */
            .class-header .btn-refresh {
                position: absolute;
                top: 20px;
                right: 20px;
            }

            thead { display: none; } /* Ocultar encabezados de tabla */
            
            tr {
                display: block;
                margin-bottom: 20px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                border: 1px solid #eee;
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                border-bottom: 1px solid #eee;
                text-align: right;
            }
            
            td:last-child { border-bottom: none; }
            
            td::before { content: attr(data-label); font-weight: bold; color: var(--primary-color); text-align: left; }
            
            /* Estilos para el acorde√≥n m√≥vil */
            td:first-child { 
                background-color: var(--primary-color); 
                color: white; 
                justify-content: flex-start; /* Alineaci√≥n a la izquierda */
                text-align: left;
                border-radius: 10px 10px 0 0; 
                cursor: pointer;
                padding-left: 20px;
                padding-right: 20px;
            }
            td:first-child::before { display: none; }

            /* Ocultar contenido por defecto en m√≥vil */
            td:not(:first-child) { display: none; }
            tr.expanded td:not(:first-child) { display: flex; animation: fadeIn 0.3s; }
        }

        /* Estilos del Popup (Modal) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .close-modal:hover { color: #000; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: var(--primary-color); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: inherit;
        }
        .info-icon {
            cursor: pointer; margin-left: 8px; color: white; opacity: 0.7; transition: opacity 0.2s;
            display: inline-block; vertical-align: middle;
        }
        .info-icon:hover { opacity: 1; transform: scale(1.1); }

        /* Barra de B√∫squeda Global (Inicio) */
        .global-search-container {
            margin: 40px auto 0 auto;
            max-width: 700px;
            position: relative;
        }
        .global-search-container input {
            width: 100%;
            padding: 18px 25px;
            border-radius: 50px;
            border: 2px solid #eee;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            text-align: center;
            box-sizing: border-box;
        }
        .global-search-container input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.15);
            outline: none;
            transform: translateY(-2px);
        }

        /* Notificaciones Toast */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideIn {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Barra de Herramientas de Filtro */
        .filter-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-toolbar select {
            flex: 1;
            min-width: 140px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            font-size: 0.9rem;
            color: var(--text-color);
            cursor: pointer;
        }
        .filter-toolbar select:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        /* Botones de Info Evaluaci√≥n en M√≥vil */
        .mobile-eval-info-container {
            display: none; /* Oculto en escritorio */
            gap: 10px;
            margin-bottom: 15px;
            justify-content: space-between;
        }
        
        .eval-info-btn {
            background-color: white;
            color: var(--text-color);
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        
        .eval-info-btn:hover {
            background-color: #f8f9fa;
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* Bot√≥n Toggle M√≥vil */
        .toggle-rows-btn {
            display: none; /* Oculto en escritorio */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            color: var(--text-color);
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }
        .toggle-rows-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* Resultados de B√∫squeda Global */
        .global-search-result {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        .global-search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .global-search-result h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            flex-grow: 1;
        }
        .global-search-result .meta {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .global-search-result .grades-summary {
            display: flex;
            gap: 10px;
        }
        .grade-badge {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
        }

        /* Header de Clase */
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 10px;
        }
        .class-header h2 { margin: 0; }
        /* En escritorio, empujamos el bot√≥n de a√±adir a la derecha si es necesario, 
           pero space-between ya lo hace. Solo aseguramos alineaci√≥n. */
    </style>
</head>
<body>

    <main>
        <!-- 1. Pantalla de Inicio -->
        <section id="screen-home" class="screen active">
            <h1>Notas Digitales</h1>
            
            <div class="flags-container">
                <button class="flag-btn" onclick="selectLanguage('Italiano')">
                    <img src="https://flagcdn.com/w320/it.png" alt="Italia">
                    <span>Italiano</span>
                </button>
                <button class="flag-btn" onclick="selectLanguage('Ingles')">
                    <img src="https://flagcdn.com/w320/gb.png" alt="Reino Unido">
                    <span>Ingl√©s</span>
                </button>
            </div>

            <div class="search-container global-search-container">
                <input type="text" id="global-search-input" placeholder="Buscar alumnos..." onkeyup="handleGlobalSearch(event)">
            </div>
        </section>

        <!-- 2. Pantalla de Selecci√≥n de Grado -->
        <section id="screen-menu" class="screen">
            <button class="back-btn" onclick="goHome()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Volver al inicio
            </button>
            <h2 id="menu-title">Selecciona el Grado</h2>
            <div class="grades-grid">
                <button class="grade-btn" onclick="selectGrade('1A')">1er Grado A</button>
                <button class="grade-btn" onclick="selectGrade('1B')">1er Grado B</button>
                <button class="grade-btn" onclick="selectGrade('2')">2do Grado</button>
                <button class="grade-btn" onclick="selectGrade('3')">3er Grado</button>
                <button class="grade-btn" onclick="selectGrade('4')">4to Grado</button>
                <button class="grade-btn" onclick="selectGrade('5')">5to Grado</button>
                <button class="grade-btn" onclick="selectGrade('6')">6to Grado</button>
            </div>
        </section>

        <!-- 4. Pantalla de Resultados de B√∫squeda Global -->
        <section id="screen-search-results" class="screen">
            <button class="back-btn" onclick="goHome()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Volver al inicio
            </button>
            <h2 id="search-title">Resultados de B√∫squeda</h2>
            <div id="global-loader" class="loader hidden">Buscando...</div>
            <div id="search-results-container">
                <!-- Resultados aqu√≠ -->
            </div>
        </section>

        <!-- 3. Pantalla de Lista de Alumnos -->
        <section id="screen-class" class="screen">
            <button class="back-btn" onclick="goBackToMenu()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Volver a grados
            </button>
            <div class="class-header">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <h2 id="class-title">Lista de Alumnos</h2>
                    <button class="btn-refresh" onclick="fetchStudents(true)" title="Actualizar lista manualmente">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    </button>
                </div>
                <button class="btn-action btn-add" onclick="addStudent()">+ Nuevo Alumno</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar alumnos..." onkeyup="filterStudents()">
            </div>
            
            <!-- Barra de Filtros y Ordenamiento -->
            <div class="filter-toolbar">
                <select id="sort-select" onchange="applySortAndFilter()">
                    <option value="default">Orden: Por defecto</option>
                    <option value="name">Nombre (A-Z)</option>
                    <option value="grade1">Nota I (Mayor a Menor)</option>
                    <option value="grade2">Nota II (Mayor a Menor)</option>
                    <option value="grade3">Nota III (Mayor a Menor)</option>
                </select>
                <select id="filter-status-select" onchange="applySortAndFilter()">
                    <option value="all">Mostrar: Todos</option>
                    <option value="with_notes_1">Eval I: Con Nota</option>
                    <option value="without_notes_1">Eval I: Sin Nota</option>
                    <option value="with_notes_2">Eval II: Con Nota</option>
                    <option value="without_notes_2">Eval II: Sin Nota</option>
                    <option value="with_notes_3">Eval III: Con Nota</option>
                    <option value="without_notes_3">Eval III: Sin Nota</option>
                </select>
                <button id="toggle-rows-btn" class="toggle-rows-btn" onclick="toggleAllRows()" title="Expandir/Contraer">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
            </div>

            <!-- Botones de Info Evaluaci√≥n (Solo M√≥vil) -->
            <div class="mobile-eval-info-container">
                <button class="eval-info-btn" onclick="openInfoModal(1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Eval. I
                </button>
                <button class="eval-info-btn" onclick="openInfoModal(2)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Eval. II
                </button>
                <button class="eval-info-btn" onclick="openInfoModal(3)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    Eval. III
                </button>
            </div>
            
            <div id="loader" class="loader hidden">Cargando datos...</div>
            
            <div class="table-wrapper">
                <table id="students-table">
                    <thead>
                        <tr>
                            <th>Alumno</th>
                            <th>
                                Nota I 
                                <svg class="info-icon" onclick="openInfoModal(1)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </th>
                            <th>
                                Nota II
                                <svg class="info-icon" onclick="openInfoModal(2)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </th>
                            <th>
                                Nota III
                                <svg class="info-icon" onclick="openInfoModal(3)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            </th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="students-body">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Popup de Informaci√≥n de Evaluaci√≥n -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeInfoModal()">&times;</span>
            <h2 id="modal-title">Informaci√≥n Evaluaci√≥n</h2>
            
            <div class="form-group">
                <label>Tipo de Evaluaci√≥n</label>
                <select id="eval-type">
                    <option value="Interrogatorio">Interrogatorio</option>
                    <option value="Examen escrito">Examen escrito</option>
                    <option value="Taller">Taller</option>
                    <option value="Exposici√≥n">Exposici√≥n</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tema</label>
                <input type="text" id="eval-topic" placeholder="Ej. Verbos irregulares">
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="eval-date">
            </div>
            <div class="form-group">
                <label>Notas Adicionales</label>
                <textarea id="eval-notes" rows="3" placeholder="Detalles extra..."></textarea>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn-action btn-delete" onclick="deleteEvalInfo()">Borrar Info</button>
                <button class="btn-action btn-add" onclick="saveEvalInfo()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Contenedor de Toasts -->
    <div id="toast-container"></div>

    <script>
        // CONFIGURACI√ìN
        // URL del Script de Google Apps (Corregida y verificada del contexto anterior)
        const API_URL = "https://script.google.com/macros/s/AKfycbxgy3A4lQ6EPg-0FSmVDIkw-8P_-3AjDtW5KutjmbOsgxh2tiomZoZe0jcpu6FTlYcs/exec"; // <--- ¬°ASEG√öRATE DE QUE ESTA SEA TU URL REAL!

        // ESTADO
        let currentLang = '';
        let currentGrade = '';
        let currentMeta = {}; // Almacena la info de las evaluaciones
        let currentStudents = []; // Almacena la lista de alumnos actual
        let currentGlobalResults = []; // Almacena resultados de b√∫squeda global
        let currentEvalIndex = null; // Para saber qu√© evaluaci√≥n se est√° editando

        // ELEMENTOS DOM
        const screenHome = document.getElementById('screen-home');
        const screenMenu = document.getElementById('screen-menu');
        const screenClass = document.getElementById('screen-class');
        const menuTitle = document.getElementById('menu-title');
        const classTitle = document.getElementById('class-title');
        const studentsBody = document.getElementById('students-body');
        const loader = document.getElementById('loader');
        const globalLoader = document.getElementById('global-loader');
        const searchResultsContainer = document.getElementById('search-results-container');
        const infoModal = document.getElementById('info-modal');

        // NAVEGACI√ìN
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        function selectLanguage(lang) {
            currentLang = lang;
            menuTitle.textContent = `Grados de ${lang}`;
            
            // Cambiar color de botones seg√∫n idioma
            const buttons = document.querySelectorAll('.grade-btn');
            buttons.forEach(btn => {
                if (lang === 'Italiano') {
                    btn.classList.add('italian');
                } else {
                    btn.classList.remove('italian');
                }
            });
            
            showScreen(screenMenu);
        }

        function goHome() {
            currentLang = '';
            showScreen(screenHome);
        }

        function selectGrade(grade) {
            currentGrade = grade;
            classTitle.textContent = `${currentLang} - Grado ${grade}`;
            showScreen(screenClass);
            fetchStudents();
        }

        function goBackToMenu() {
            currentGrade = '';
            studentsBody.innerHTML = ''; // Limpiar tabla
            showScreen(screenMenu);
        }

        // L√ìGICA DE DATOS
        async function fetchStudents(isManual = false) {
            loader.classList.remove('hidden');
            studentsBody.innerHTML = '';
            
            // Limpiar b√∫squeda al recargar datos
            if(document.getElementById('search-input')) document.getElementById('search-input').value = '';
            
            // Reiniciar filtros
            if(document.getElementById('sort-select')) document.getElementById('sort-select').value = 'default';
            if(document.getElementById('filter-status-select')) document.getElementById('filter-status-select').value = 'all';

            try {
                // Construir URL con par√°metros
                const url = `${API_URL}?lang=${currentLang}&grade=${currentGrade}&t=${new Date().getTime()}`;
                
                const response = await fetch(url);
                const responseData = await response.json();

                if (responseData.error) {
                    alert('Error: ' + responseData.error);
                    return;
                }

                // Separar alumnos y metadatos
                const students = responseData.students || [];
                currentStudents = students;
                currentMeta = responseData.meta || {};
                
                renderTable(students);
                if (isManual && students.length > 0) showToast('Lista actualizada');

            } catch (error) {
                console.error(error);
                studentsBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">Error al cargar datos. Verifica tu conexi√≥n.</td></tr>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderTable(students) {
            studentsBody.innerHTML = ''; // IMPORTANTE: Limpiar tabla antes de renderizar para evitar duplicados
            if (!students || students.length === 0) {
                studentsBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No hay alumnos registrados (o no coinciden con el filtro).</td></tr>`;
                return;
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                
                // Asumimos que las columnas en el Sheet son: studentId, Nombres, Apellidos, Nota I, Fecha I
                // Si no existen, usamos fallbacks vac√≠os
                const nombreCompleto = `${student.Nombres || ''} ${student.Apellidos || ''}`.trim() || student['Nombre Completo'] || 'Sin Nombre';

                row.innerHTML = `
                    <td data-label="Alumno" onclick="toggleMobileRow(this)">${nombreCompleto}</td>
                    ${renderGradeCell(student, 'Nota I', 'Fecha I', 1)}
                    ${renderGradeCell(student, 'Nota II', 'Fecha II', 2)}
                    ${renderGradeCell(student, 'Nota III', 'Fecha III', 3)}
                    <td data-label="Acci√≥n" style="text-align: center;">
                        <div class="action-menu-container">
                            <button class="btn-menu" onclick="toggleActionMenu(event, '${student.studentId}')">‚ãÆ</button>
                            <div id="menu-${student.studentId}" class="dropdown-content">
                                <button onclick="editStudent('${student.studentId}')">‚úèÔ∏è Editar Nombre</button>
                                <button class="delete-option" onclick="deleteStudent('${student.studentId}')">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    </td>
                `;
                studentsBody.appendChild(row);
            });
        }

        // Funci√≥n auxiliar para crear la celda de nota + fecha
        function renderGradeCell(student, noteKey, dateKey, evalIndex) {
            const notaActual = student[noteKey] || '';
            const fechaActual = student[dateKey] || '';
            const dateStr = fechaActual ? new Date(fechaActual).toLocaleDateString() : '-';

            return `
                <td data-label="${noteKey}">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <select onchange="updateGrade('${student.studentId}', this, ${evalIndex})">
                            <option value="" ${notaActual === '' ? 'selected' : ''}>-</option>
                            <option value="A+" ${notaActual === 'A+' ? 'selected' : ''}>A+</option>
                            <option value="A" ${notaActual === 'A' ? 'selected' : ''}>A</option>
                            <option value="B" ${notaActual === 'B' ? 'selected' : ''}>B</option>
                            <option value="C" ${notaActual === 'C' ? 'selected' : ''}>C</option>
                            <option value="D" ${notaActual === 'D' ? 'selected' : ''}>D</option>
                            <option value="E" ${notaActual === 'E' ? 'selected' : ''}>E</option>
                            <option value="F" ${notaActual === 'F' ? 'selected' : ''}>F</option>
                        </select>
                        <span class="date-label" style="font-size:0.75rem; color:#7f8c8d;">${dateStr}</span>
                    </div>
                </td>
            `;
        }

        // --- FUNCI√ìN CENTRAL DE ENV√çO (M√âTODO ROBUSTO) ---
        async function sendDataToScript(payload) {
            console.log("Enviando a Google Sheet:", payload);
            
            // Usamos URLSearchParams para enviar como formulario.
            // Este es el m√©todo que S√ç lograba comunicarse con el script.
            const params = new URLSearchParams();
            params.append('payload', JSON.stringify(payload));

            // Intentar hasta 3 veces si hay error de red (com√∫n en m√≥viles tras inactividad)
            for (let i = 0; i < 3; i++) {
                try {
                    await fetch(`${API_URL}?t=${new Date().getTime()}`, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: params
                    });
                    return; // √âxito
                } catch (error) {
                    console.warn(`Intento ${i + 1} fallido:`, error);
                    if (i === 2) throw error; // Si falla la 3ra vez, lanzamos el error
                    await new Promise(r => setTimeout(r, 1000)); // Esperar 1 seg
                }
            }
        }

        // --- SISTEMA DE NOTIFICACIONES ---
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            // Eliminar despu√©s de 3 segundos
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        async function updateGrade(studentId, selectElement, evalIndex) {
            const newGrade = selectElement.value;
            const cell = selectElement.closest('div');
            const dateLabel = cell.querySelector('.date-label');
            
            // Feedback visual inmediato (Deshabilitar)
            selectElement.disabled = true;
            document.body.style.cursor = 'wait';

            const payload = {
                lang: currentLang,
                grade: currentGrade,
                studentId: studentId,
                newGrade: newGrade,
                evalIndex: evalIndex,
                action: 'updateGrade'
            };

            try {
                await sendDataToScript(payload);

                // Como es no-cors, asumimos √©xito si no lanza error de red
                // Actualizamos la fecha localmente
                const today = new Date().toLocaleDateString();
                dateLabel.textContent = newGrade ? today : '-';
                
                // Efecto visual de √©xito (borde verde temporal)
                selectElement.style.borderColor = 'var(--success-color)';
                setTimeout(() => selectElement.style.borderColor = '#ddd', 2000);
                
                // Mostrar notificaci√≥n
                showToast('Nota guardada correctamente');

            } catch (error) {
                console.error('Error saving grade:', error);
                alert('No se pudo guardar la nota. Intenta de nuevo.');
                // Revertir cambio visualmente si es posible, o recargar
            } finally {
                selectElement.disabled = false;
                document.body.style.cursor = 'default';
            }
        }

        async function addStudent() {
            const nombres = prompt("Ingrese los Nombres del alumno:");
            if (!nombres) return;
            const apellidos = prompt("Ingrese los Apellidos del alumno:");
            if (!apellidos) return;

            loader.classList.remove('hidden');
            
            const payload = {
                action: 'addStudent',
                lang: currentLang,
                grade: currentGrade,
                nombres: nombres,
                apellidos: apellidos
            };

            try {
                await sendDataToScript(payload);
                showToast('Alumno agregado correctamente');
                // Recargar la tabla para ver el nuevo alumno (con un peque√±o delay para asegurar que GS proces√≥)
                setTimeout(fetchStudents, 1500);
            } catch (error) {
                console.error(error);
                alert("Error al agregar alumno.");
                loader.classList.add('hidden');
            }
        }

        // --- GESTI√ìN DE MEN√öS Y EDICI√ìN ---
        
        // Cerrar men√∫s al hacer clic fuera
        window.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        });

        function toggleActionMenu(event, id) {
            event.stopPropagation(); // Evitar que el click cierre el men√∫ inmediatamente
            // Cerrar otros men√∫s abiertos
            document.querySelectorAll('.dropdown-content').forEach(d => {
                if (d.id !== 'menu-' + id) d.classList.remove('show');
            });
            document.getElementById('menu-' + id).classList.toggle('show');
        }

        async function editStudent(studentId, lang = null, grade = null) {
            let student;
            let isGlobal = false;

            // Determinar si estamos editando desde b√∫squeda global o lista de clase
            if (lang && grade) {
                isGlobal = true;
                // En b√∫squeda global el ID viene como 'id', en lista de clase como 'studentId'
                student = currentGlobalResults.find(s => String(s.id) === String(studentId) && s.lang === lang && s.grade === grade);
            } else {
                student = currentStudents.find(s => String(s.studentId) === String(studentId));
            }
            
            if (!student && !isGlobal) return; // Si no encontramos al alumno en la lista local
            // Si es global y no encontramos el objeto, usamos placeholders vac√≠os si es necesario, pero deber√≠a encontrarse.

            const newName = prompt("Editar Nombres:", student.Nombres || '');
            if (newName === null) return;
            const newSurname = prompt("Editar Apellidos:", student.Apellidos || '');
            if (newSurname === null) return;

            loader.classList.remove('hidden');
            
            const payload = {
                action: 'editStudent',
                lang: lang || currentLang,
                grade: grade || currentGrade,
                studentId: studentId,
                nombres: newName,
                apellidos: newSurname
            };

            try {
                await sendDataToScript(payload);
                showToast('Nombre actualizado correctamente');
                
                if (isGlobal) {
                    const query = document.getElementById('global-search-input').value;
                    setTimeout(() => performGlobalSearch(query), 1500);
                } else {
                    setTimeout(fetchStudents, 1500);
                }
            } catch (error) {
                console.error(error);
                alert("Error al editar alumno.");
                loader.classList.add('hidden');
            }
        }

        async function deleteStudent(studentId, lang = null, grade = null) {
            if (!confirm("¬øEst√°s seguro de que quieres eliminar a este alumno y todas sus notas? Esta acci√≥n no se puede deshacer.")) return;

            loader.classList.remove('hidden');
            const payload = { action: 'deleteStudent', lang: lang || currentLang, grade: grade || currentGrade, studentId: studentId };

            try {
                await sendDataToScript(payload);
                showToast('Alumno eliminado correctamente');
                
                if (lang && grade) {
                    const query = document.getElementById('global-search-input').value;
                    setTimeout(() => performGlobalSearch(query), 1500);
                } else {
                    setTimeout(fetchStudents, 1500);
                }
            } catch (error) {
                console.error(error);
                alert("Error al eliminar alumno.");
                loader.classList.add('hidden');
            }
        }

        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
        }

        function filterStudents() {
            const input = document.getElementById('search-input');
            const filterTerms = normalizeText(input.value).split(" ").filter(term => term.trim() !== "");
            const rows = studentsBody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const td = rows[i].getElementsByTagName('td')[0]; // Primera celda (Nombre)
                if (td) {
                    const txtValue = normalizeText(td.textContent || td.innerText);
                    const isMatch = filterTerms.every(term => txtValue.indexOf(term) > -1);
                    rows[i].style.display = isMatch ? "" : "none";
                }
            }
        }
        
        // --- ORDENAMIENTO Y FILTRADO ---
        const gradeValues = { 'A+': 8, 'A': 7, 'B': 6, 'C': 5, 'D': 4, 'E': 3, 'F': 2, '': 0, '-': 0 };

        function applySortAndFilter() {
            const sortType = document.getElementById('sort-select').value;
            const filterType = document.getElementById('filter-status-select').value;
            
            if (!currentStudents) return;

            // 1. Filtrar
            let filtered = currentStudents.filter(s => {
                const checkNote = (val) => val && val !== '-' && val !== '';
                
                if (filterType === 'with_notes_1') return checkNote(s['Nota I']);
                if (filterType === 'without_notes_1') return !checkNote(s['Nota I']);
                
                if (filterType === 'with_notes_2') return checkNote(s['Nota II']);
                if (filterType === 'without_notes_2') return !checkNote(s['Nota II']);
                
                if (filterType === 'with_notes_3') return checkNote(s['Nota III']);
                if (filterType === 'without_notes_3') return !checkNote(s['Nota III']);
                
                return true; // 'all'
            });

            // 2. Ordenar
            if (sortType === 'name') {
                filtered.sort((a, b) => {
                    const nameA = `${a.Nombres} ${a.Apellidos}`.toLowerCase();
                    const nameB = `${b.Nombres} ${b.Apellidos}`.toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            } else if (sortType.startsWith('grade')) {
                const keyMap = { 'grade1': 'Nota I', 'grade2': 'Nota II', 'grade3': 'Nota III' };
                const key = keyMap[sortType];
                filtered.sort((a, b) => {
                    const valA = gradeValues[a[key]] || 0;
                    const valB = gradeValues[b[key]] || 0;
                    return valB - valA; // Descendente (Mayor a Menor)
                });
            }

            renderTable(filtered);
            filterStudents(); // Re-aplicar b√∫squeda de texto si existe
        }

        function toggleMobileRow(cell) {
            // Solo activa si estamos en vista m√≥vil
            if (window.innerWidth <= 1024) {
                cell.parentElement.classList.toggle('expanded');
            }
        }

        let isRowsExpanded = false;
        function toggleAllRows() {
            isRowsExpanded = !isRowsExpanded;
            const rows = document.querySelectorAll('#students-body tr');
            rows.forEach(row => {
                if (isRowsExpanded) row.classList.add('expanded');
                else row.classList.remove('expanded');
            });
            
            // Actualizar icono
            const btn = document.getElementById('toggle-rows-btn');
            if (isRowsExpanded) btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>';
            else btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';
        }

        // --- L√ìGICA DEL POPUP DE INFORMACI√ìN ---
        function openInfoModal(evalIndex) {
            currentEvalIndex = evalIndex;
            document.getElementById('modal-title').textContent = `Informaci√≥n Evaluaci√≥n #${evalIndex}`;
            
            // Cargar datos si existen
            const infoStr = currentMeta[evalIndex];
            let info = {};
            try {
                // Verificamos si parece JSON antes de parsear para evitar errores con encabezados de texto
                if (infoStr && typeof infoStr === 'string' && infoStr.trim().startsWith('{')) {
                    info = JSON.parse(infoStr);
                }
            } catch (e) { console.warn("No se pudo leer la info (se reiniciar√°):", e); }

            document.getElementById('eval-type').value = info.type || 'Interrogatorio';
            document.getElementById('eval-topic').value = info.topic || '';
            document.getElementById('eval-date').value = info.date || '';
            document.getElementById('eval-notes').value = info.notes || '';

            infoModal.style.display = 'flex';
        }

        function closeInfoModal() {
            infoModal.style.display = 'none';
            currentEvalIndex = null;
        }

        async function saveEvalInfo() {
            if (!currentEvalIndex) return;

            const info = {
                type: document.getElementById('eval-type').value,
                topic: document.getElementById('eval-topic').value,
                date: document.getElementById('eval-date').value,
                notes: document.getElementById('eval-notes').value
            };

            // Actualizar localmente
            currentMeta[currentEvalIndex] = JSON.stringify(info);

            const payload = {
                action: 'updateEvalInfo',
                lang: currentLang,
                grade: currentGrade,
                evalIndex: parseInt(currentEvalIndex, 10), // Forzar env√≠o como n√∫mero
                info: info
            };

            closeInfoModal();
            loader.classList.remove('hidden');

            try {
                await sendDataToScript(payload);
                showToast('Informaci√≥n guardada correctamente');
                // No recargamos toda la tabla, solo ocultamos el loader
            } catch (error) {
                alert("Error al guardar informaci√≥n.");
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function deleteEvalInfo() {
            if (!confirm("¬øBorrar toda la informaci√≥n de esta evaluaci√≥n?")) return;
            document.getElementById('eval-topic').value = '';
            document.getElementById('eval-date').value = '';
            document.getElementById('eval-notes').value = '';
            saveEvalInfo(); // Guardar vac√≠o
        }

        // --- B√öSQUEDA GLOBAL ---
        async function handleGlobalSearch(event) {
            if (event.key === 'Enter') {
                const query = document.getElementById('global-search-input').value;
                if (!query.trim()) return;
                performGlobalSearch(query);
            }
        }

        async function performGlobalSearch(query) {
            showScreen(document.getElementById('screen-search-results'));
            document.getElementById('search-title').textContent = `Resultados para "${query}"`;
            searchResultsContainer.innerHTML = '';
            globalLoader.classList.remove('hidden');

            try {
                // Usamos el par√°metro 'q' para indicar b√∫squeda global al backend
                const url = `${API_URL}?q=${encodeURIComponent(query)}&t=${new Date().getTime()}`;
                const response = await fetch(url);
                const results = await response.json();

                if (results.error) throw new Error(results.error);
                
                // Guardamos resultados para poder editarlos
                currentGlobalResults = results;
                renderGlobalResults(results);
            } catch (error) {
                console.error(error);
                searchResultsContainer.innerHTML = `<p style="text-align:center; color:red;">Error en la b√∫squeda.</p>`;
            } finally {
                globalLoader.classList.add('hidden');
            }
        }

        function renderGlobalResults(results) {
            if (!results || results.length === 0) {
                searchResultsContainer.innerHTML = `<p style="text-align:center;">No se encontraron alumnos.</p>`;
                return;
            }

            results.forEach(student => {
                // Generamos un ID √∫nico para el men√∫ en la b√∫squeda global para evitar conflictos
                const menuId = `global-${student.lang}-${student.grade}-${student.id}`;
                
                const div = document.createElement('div');
                div.className = 'global-search-result';
                div.innerHTML = `
                    <div class="global-search-result-header">
                        <div>
                            <h3>${student.nombres} ${student.apellidos}</h3>
                            <div class="meta">Idioma: <strong>${student.lang}</strong> | Grado: <strong>${student.grade}</strong></div>
                        </div>
                        <div class="action-menu-container">
                            <button class="btn-menu" onclick="toggleActionMenu(event, '${menuId}')">‚ãÆ</button>
                            <div id="menu-${menuId}" class="dropdown-content">
                                <button onclick="editStudent('${student.id}', '${student.lang}', '${student.grade}')">‚úèÔ∏è Editar Nombre</button>
                                <button class="delete-option" onclick="deleteStudent('${student.id}', '${student.lang}', '${student.grade}')">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    </div>
                    <div class="grades-summary">
                        <span class="grade-badge">Nota I: ${student.nota1 || '-'}</span>
                        <span class="grade-badge">Nota II: ${student.nota2 || '-'}</span>
                        <span class="grade-badge">Nota III: ${student.nota3 || '-'}</span>
                    </div>
                `;
                searchResultsContainer.appendChild(div);
            });
        }
    </script>
</body>
</html>
